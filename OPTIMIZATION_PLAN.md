# é£ä¹¦æœºå™¨äººä¼˜åŒ–è®¡åˆ’

## ğŸ“… åˆ›å»ºæ—¥æœŸ
2026-01-21

---

## ğŸ”§ é«˜ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆé˜»å¡æ€§é—®é¢˜ï¼‰

### 1. é‡è¿æœºåˆ¶é—®é¢˜
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - é˜»å¡æ€§
**å½“å‰é—®é¢˜**:
- `MessageListenerGatewayImpl.reconnect()` æ–¹æ³•å·²å®šä¹‰ä½†æœªè¢«è°ƒç”¨
- è¿æ¥æ–­å¼€åä¸ä¼šè‡ªåŠ¨é‡è¿
- SDK å¯èƒ½éœ€è¦ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–

**ä¿®å¤æ–¹æ¡ˆ**:
1. åœ¨ `registerMessageHandler()` ä¸­æ³¨å†Œ SDK çš„è¿æ¥æ–­å¼€å›è°ƒ
2. è¿æ¥æ–­å¼€æ—¶è§¦å‘ `reconnect()` æ–¹æ³•
3. æ”¹è¿›é‡è¿ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ + æœ€å¤§é‡è¯•æ¬¡æ•°

**å½±å“æ–‡ä»¶**:
- `feishu-bot-infrastructure/src/main/java/com/qdw/feishu/infrastructure/gateway/MessageListenerGatewayImpl.java`

**é¢„æœŸæ•ˆæœ**:
- è¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¿
- æœ€å¤šé‡è¯• 10 æ¬¡ï¼Œé—´éš”ä» 1s æŒ‡æ•°å¢é•¿åˆ° 30s
- é‡è¿å¤±è´¥ååœæ­¢ç›‘å¬å¹¶è®°å½•é”™è¯¯æ—¥å¿—

---

### 2. BotMessageService æœªæ³¨å†Œä¸º Spring Bean
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - é˜»å¡æ€§
**å½“å‰é—®é¢˜**:
- `BotMessageService` ç¼ºå°‘ `@Service` æ³¨è§£
- æ— æ³•è¢« Spring å®¹å™¨æ‰«æå’Œæ³¨å…¥
- `ReceiveMessageListenerExe` æ— æ³•è·å–è¯¥ä¾èµ–

**ä¿®å¤æ–¹æ¡ˆ**:
- åœ¨ `BotMessageService` ç±»ä¸Šæ·»åŠ  `@Service` æ³¨è§£

**å½±å“æ–‡ä»¶**:
- `feishu-bot-domain/src/main/java/com/qdw/feishu/domain/service/BotMessageService.java`

**é¢„æœŸæ•ˆæœ**:
- BotMessageService è¢« Spring å®¹å™¨ç®¡ç†
- ä¾èµ–æ³¨å…¥æ­£å¸¸å·¥ä½œ
- åº”ç”¨å¯ä»¥æ­£å¸¸å¯åŠ¨

---

### 3. FeishuProperties ç¼ºå°‘ listener é…ç½®
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - é˜»å¡æ€§
**å½“å‰é—®é¢˜**:
- `application.yml` ä¸­å®šä¹‰äº† `feishu.listener.*` é…ç½®
- `FeishuProperties` ç±»ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µ
- é…ç½®æ— æ³•ç”Ÿæ•ˆ

**ä¿®å¤æ–¹æ¡ˆ**:
- æ·»åŠ åµŒå¥—é™æ€ç±» `Listener`
- æ·»åŠ  `Reconnect` å’Œ `Timeout` é…ç½®ç±»
- æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–å’Œé»˜è®¤å€¼

**å½±å“æ–‡ä»¶**:
- `feishu-bot-infrastructure/src/main/java/com/qdw/feishu/infrastructure/config/FeishuProperties.java`

**é¢„æœŸæ•ˆæœ**:
- é…ç½®å¯ä»¥æ­£å¸¸åŠ è½½
- æ”¯æŒçµæ´»çš„å‚æ•°é…ç½®
- é…ç½®å€¼å¯è¢«æ­£ç¡®è¯»å–

---

### 4. FeishuEventListener ç¼ºå°‘ @Component æ³¨è§£
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - é˜»å¡æ€§
**å½“å‰é—®é¢˜**:
- `FeishuEventListener` ç±»æ²¡æœ‰ `@Component` æ³¨è§£
- ä¸ä¼šè¢« Spring å®¹å™¨æ‰«æ
- é•¿è¿æ¥æ— æ³•è‡ªåŠ¨å¯åŠ¨

**ä¿®å¤æ–¹æ¡ˆ**:
- åœ¨ `FeishuEventListener` ç±»ä¸Šæ·»åŠ  `@Component` æ³¨è§£
- ç¡®ä¿åŒ…æ‰«æè·¯å¾„æ­£ç¡®

**å½±å“æ–‡ä»¶**:
- `feishu-bot-adapter/src/main/java/com/qdw/feishu/adapter/listener/FeishuEventListener.java`

**é¢„æœŸæ•ˆæœ**:
- FeishuEventListener è¢« Spring å®¹å™¨ç®¡ç†
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–é•¿è¿æ¥
- `ApplicationRunner` æ­£å¸¸æ‰§è¡Œ

---

## ğŸ“Š ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–

### 5. æ¶ˆæ¯å¤„ç†æœªä½¿ç”¨é…ç½®çš„æ‰©å±•ç‚¹
**ä¼˜å…ˆçº§**: ğŸŸ¡ P1
**å½“å‰é—®é¢˜**:
- `Message.generateReply()` è¿”å›ç¡¬ç¼–ç çš„ `"ä½ è¯´: %s"`
- æ²¡æœ‰ä½¿ç”¨ `ReplyExtensionPt` æ‰©å±•ç‚¹
- å›å¤é€»è¾‘æ— æ³•çµæ´»æ‰©å±•

**ä¿®å¤æ–¹æ¡ˆ**:
- åœ¨ `Message` æˆ– `BotMessageService` ä¸­æ³¨å…¥ `ExtensionExecutor`
- ä½¿ç”¨æ‰©å±•ç‚¹å¢å¼ºå›å¤å†…å®¹
- æ”¯æŒ AI å›å¤ã€å…³é”®è¯å›å¤ç­‰å¤šç§ç­–ç•¥

**å½±å“æ–‡ä»¶**:
- `feishu-bot-domain/src/main/java/com/qdw/feishu/domain/message/Message.java`
- `feishu-bot-domain/src/main/java/com/qdw/feishu/domain/service/BotMessageService.java`

---

### 6. ç¼ºå°‘æ¶ˆæ¯ç¼“å­˜å’Œå»é‡
**ä¼˜å…ˆçº§**: ğŸŸ¡ P1
**å½“å‰é—®é¢˜**:
- æ²¡æœ‰æ¶ˆæ¯å»é‡æœºåˆ¶
- å¯èƒ½å¯¼è‡´é‡å¤å¤„ç†
- æ— æ³•ä¿è¯æ¶ˆæ¯å¹‚ç­‰æ€§

**ä¿®å¤æ–¹æ¡ˆ**:
- ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜
- ä»¥ `messageId` ä¸ºé”®å­˜å‚¨å·²å¤„ç†æ¶ˆæ¯
- è®¾ç½® TTLï¼ˆ5 åˆ†é’Ÿï¼‰

**å½±å“æ–‡ä»¶**:
- æ–°å»º: `feishu-bot-infrastructure/src/main/java/com/qdw/feishu/infrastructure/cache/MessageCacheService.java`

---

### 7. å¿ƒè·³æœºåˆ¶æœªå®ç°
**ä¼˜å…ˆçº§**: ğŸŸ¡ P1
**å½“å‰é—®é¢˜**:
- é…ç½®ä¸­æœ‰ `heartbeat-interval`ï¼Œä½†ä»£ç ä¸­æœªä½¿ç”¨
- æ— æ³•ä¸»åŠ¨æ£€æµ‹è¿æ¥å¥åº·çŠ¶æ€
- è¿æ¥æ–­å¼€å¯èƒ½å»¶è¿Ÿå‘ç°

**ä¿®å¤æ–¹æ¡ˆ**:
- ä½¿ç”¨ `@Scheduled` å®ç°å¿ƒè·³æ£€æµ‹
- å®šæœŸå‘é€ PING æ¶ˆæ¯
- å¿ƒè·³å¤±è´¥è§¦å‘é‡è¿

**å½±å“æ–‡ä»¶**:
- `feishu-bot-adapter/src/main/java/com/qdw/feishu/adapter/listener/FeishuEventListener.java`
- `feishu-bot-infrastructure/src/main/java/com/qdw/feishu/infrastructure/gateway/MessageListenerGatewayImpl.java`

---

### 8. FeishuGatewayImpl.getUserInfo() æ˜¯ç©ºå®ç°
**ä¼˜å…ˆçº§**: ğŸŸ¡ P1
**å½“å‰é—®é¢˜**:
- æ€»æ˜¯è¿”å›å ä½æ•°æ®
- æ— æ³•è·å–çœŸå®çš„ç”¨æˆ·ä¿¡æ¯
- é™åˆ¶äº†æ¶ˆæ¯ä¸ªæ€§åŒ–èƒ½åŠ›

**ä¿®å¤æ–¹æ¡ˆ**:
- è°ƒç”¨é£ä¹¦ SDK è·å–ç”¨æˆ·ä¿¡æ¯
- ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆå‡å°‘ API è°ƒç”¨ï¼‰
- å¼‚å¸¸æ—¶è¿”å›é»˜è®¤å€¼

**å½±å“æ–‡ä»¶**:
- `feishu-bot-infrastructure/src/main/java/com/qdw/feishu/infrastructure/gateway/FeishuGatewayImpl.java`

---

## ğŸ” ä½ä¼˜å…ˆçº§ä¼˜åŒ–

### 9. æ—¥å¿—å¯ä»¥æ›´ç»“æ„åŒ–
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- ä½¿ç”¨ MDC æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç”¨æˆ·IDã€æ¶ˆæ¯IDï¼‰
- ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆJSONï¼‰
- å…³é”®æ“ä½œæ·»åŠ å®¡è®¡æ—¥å¿—

### 10. ç¼ºå°‘å¥åº·æ£€æŸ¥ç«¯ç‚¹
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- æ·»åŠ  `/health` ç«¯ç‚¹
- è¿”å›è¿æ¥çŠ¶æ€ã€æ¶ˆæ¯å¤„ç†ç»Ÿè®¡
- æ”¯æŒ Kubernetes é›†æˆ

### 11. ç¼ºå°‘ç›‘æ§æŒ‡æ ‡
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- ä½¿ç”¨ Micrometer æ·»åŠ  Prometheus æŒ‡æ ‡
- ç›‘æ§ï¼šæ¶ˆæ¯æ¥æ”¶/å‘é€æ•°é‡ã€å¤„ç†æ—¶é—´ã€é”™è¯¯ç‡
- ç›‘æ§è¿æ¥çŠ¶æ€å’Œé‡è¿æ¬¡æ•°

### 12. æ¶ˆæ¯å¤„ç†åŒæ­¥é—®é¢˜
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- é…ç½®ä¸“é—¨çš„çº¿ç¨‹æ± 
- è®¾ç½®åˆç†çš„é˜Ÿåˆ—å®¹é‡
- å®ç°æ‹’ç»ç­–ç•¥ï¼ˆCallerRunsPolicyï¼‰

### 13. ç¼ºå°‘å•å…ƒæµ‹è¯•
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- ä¸º `Message.validate()` æ·»åŠ æµ‹è¯•
- ä¸º `BotMessageService.handleMessage()` æ·»åŠ æµ‹è¯•
- Mock `FeishuGateway` è¿›è¡Œé›†æˆæµ‹è¯•

### 14. ç¼ºå°‘æ¶ˆæ¯æŒä¹…åŒ–
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- å°†é‡è¦æ¶ˆæ¯å­˜å‚¨åˆ°æ•°æ®åº“
- è®°å½•æ¶ˆæ¯å¤„ç†å†å²
- æ”¯æŒæ¶ˆæ¯å›æº¯å’Œé—®é¢˜æ’æŸ¥

---

## ğŸš€ æ¶æ„ä¼˜åŒ–

### 15. è€ƒè™‘ä½¿ç”¨é¢†åŸŸäº‹ä»¶
**ä¼˜å…ˆçº§**: ğŸŸ¢ P3
**å»ºè®®**:
- æ¶ˆæ¯å¤„ç†å®Œæˆåå‘å¸ƒé¢†åŸŸäº‹ä»¶
- è§£è€¦æ ¸å¿ƒé€»è¾‘å’Œå‰¯ä½œç”¨
- æ”¯æŒäº‹ä»¶æº¯æº

### 16. è€ƒè™‘ä½¿ç”¨ CQRS æ¨¡å¼
**ä¼˜å…ˆçº§**: ğŸŸ¢ P3
**å»ºè®®**:
- åˆ†ç¦»æ¶ˆæ¯å†™å…¥å’ŒæŸ¥è¯¢æ“ä½œ
- å†™å…¥ï¼š`MessageCommandService`
- æŸ¥è¯¢ï¼š`MessageQueryService`

### 17. è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
**ä¼˜å…ˆçº§**: ğŸŸ¢ P3
**å»ºè®®**:
- å°†æ¶ˆæ¯å¤„ç†æ”¾å…¥é˜Ÿåˆ—
- è§£è€¦æ¥æ”¶å’Œå¤„ç†
- æ”¯æŒæ°´å¹³æ‰©å±•

---

## ğŸ“ ä»£ç è´¨é‡ä¼˜åŒ–

### 18. æå–å¸¸é‡
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- åˆ›å»º `FeishuConstants` ç±»
- ç»Ÿä¸€ç®¡ç†é­”æ³•å€¼
- æé«˜ä»£ç å¯ç»´æŠ¤æ€§

### 19. æ”¹è¿›å¼‚å¸¸å¤„ç†
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•å¼‚å¸¸
- ä¸ºä¸åŒå¼‚å¸¸é…ç½®ä¸åŒçš„é‡è¯•ç­–ç•¥
- æ·»åŠ å¼‚å¸¸é™çº§é€»è¾‘

### 20. æ·»åŠ æ–‡æ¡£
**ä¼˜å…ˆçº§**: ğŸŸ¢ P2
**å»ºè®®**:
- æ·»åŠ  JavaDoc æ³¨é‡Š
- ç¼–å†™ API æ–‡æ¡£
- è®°å½•éƒ¨ç½²å’Œè¿ç»´æŒ‡å—

---

## âœ… ä¼˜å…ˆçº§æ€»ç»“

### ç«‹å³ä¿®å¤ï¼ˆé˜»å¡æ€§é—®é¢˜ - P0ï¼‰
1. é‡è¿æœºåˆ¶æœªè¢«è°ƒç”¨
2. BotMessageService æœªæ³¨å†Œ
3. FeishuProperties ç¼ºå°‘é…ç½®
4. FeishuEventListener ç¼ºå°‘æ³¨è§£

**é¢„è®¡å·¥ä½œé‡**: 2-4 å°æ—¶
**é£é™©ç­‰çº§**: ä½
**å½±å“èŒƒå›´**: æ ¸å¿ƒåŠŸèƒ½

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2 å‘¨ - P1ï¼‰
5. æ‰©å±•ç‚¹æœªä½¿ç”¨
6. æ¶ˆæ¯å»é‡
7. å¿ƒè·³æœºåˆ¶
8. getUserInfo å®ç°

**é¢„è®¡å·¥ä½œé‡**: 1-2 å‘¨
**é£é™©ç­‰çº§**: ä¸­
**å½±å“èŒƒå›´**: ç¨³å®šæ€§å’Œæ€§èƒ½

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2 æœˆ - P2ï¼‰
9-14. æ—¥å¿—ã€å¥åº·æ£€æŸ¥ã€ç›‘æ§ã€æµ‹è¯•ã€æŒä¹…åŒ–

**é¢„è®¡å·¥ä½œé‡**: 2-4 å‘¨
**é£é™©ç­‰çº§**: ä½
**å½±å“èŒƒå›´**: å¯è§‚æµ‹æ€§å’Œå¯ç»´æŠ¤æ€§

### é•¿æœŸä¼˜åŒ–ï¼ˆæ¶æ„æ¼”è¿› - P3ï¼‰
15-17. é¢†åŸŸäº‹ä»¶ã€CQRSã€æ¶ˆæ¯é˜Ÿåˆ—

**é¢„è®¡å·¥ä½œé‡**: 1-2 æœˆ
**é£é™©ç­‰çº§**: é«˜
**å½±å“èŒƒå›´**: æ¶æ„é‡æ„

---

## ğŸ“Š æ‰§è¡Œè®¡åˆ’

### Phase 1: é˜»å¡æ€§é—®é¢˜ä¿®å¤ï¼ˆæœ¬å‘¨ï¼‰âœ… å·²å®Œæˆ
- [x] åˆ›å»ºä¼˜åŒ–è®¡åˆ’æ–‡æ¡£
- [x] ä¿®å¤é‡è¿æœºåˆ¶ - é‡‡ç”¨ SDK å†…ç½®æœºåˆ¶
- [x] æ³¨å†Œ BotMessageService - æ·»åŠ  @Service æ³¨è§£
- [x] å®Œå–„ FeishuProperties - æ·»åŠ  listener é…ç½®
- [x] FeishuEventListener @Component æ³¨è§£ - å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹
- [x] ä¿®å¤ SDK ä¾èµ–åæ ‡ - larksuite-oapi:2.4.22 â†’ oapi-sdk:2.5.2
- [x] ç¼–è¯‘æµ‹è¯• - BUILD SUCCESS
- [ ] åŠŸèƒ½éªŒè¯ - å¯åŠ¨åº”ç”¨æµ‹è¯•

### Phase 2: æ ¸å¿ƒåŠŸèƒ½å®Œå–„ï¼ˆä¸‹å‘¨ï¼‰
- [ ] å®ç°æ‰©å±•ç‚¹æœºåˆ¶
- [ ] æ·»åŠ æ¶ˆæ¯å»é‡
- [ ] å®ç°å¿ƒè·³æ£€æµ‹
- [ ] å®Œæˆ getUserInfo
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–

### Phase 3: å¯è§‚æµ‹æ€§æå‡ï¼ˆ2 å‘¨åï¼‰
- [ ] ç»“æ„åŒ–æ—¥å¿—
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] Prometheus æŒ‡æ ‡
- [ ] æ¶ˆæ¯æŒä¹…åŒ–

### Phase 4: æ¶æ„æ¼”è¿›ï¼ˆæŒ‰éœ€ï¼‰
- [ ] é¢†åŸŸäº‹ä»¶
- [ ] CQRS æ¨¡å¼
- [ ] æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ

---

## ğŸ“š å‚è€ƒèµ„æ–™

- é£ä¹¦ IM SDK æ–‡æ¡£: https://open.feishu.cn/document/serverSdk/im sdk
- é£ä¹¦ WebSocket æ–‡æ¡£: https://open.feishu.cn/document/serverSdk/event-sdk
- COLA æ¡†æ¶: https://github.com/alibaba/COLA
- Spring Boot æœ€ä½³å®è·µ: https://spring.io/guides
