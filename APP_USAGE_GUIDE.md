# 飞书机器人应用使用指南

本文档详细说明每个应用的使用流程和命令格式。

---

## 📋 应用概览

| 应用ID | 应用名称 | 主要功能 | 触发命令 | 别名 |
|--------|---------|---------|---------|------|
| `help` | 帮助信息 | 显示所有可用命令 | `/help` | `h`, `?`, `man` |
| `time` | 时间查询 | 查询当前系统时间 | `/time` | `t`, `now`, `date` |
| `bash` | 命令执行 | 执行安全的bash命令 | `/bash <命令>` | `cmd`, `shell`, `exec` |
| `history` | 历史查询 | 查询对话历史消息 | `/history` | 无 |
| `opencode` | OpenCode 助手 | 通过飞书对话控制 OpenCode | `/opencode <子命令>` | `oc`, `code` |

---

## 1️⃣ HelpApp - 帮助信息

### 📝 功能说明
显示所有可用应用的命令列表和使用说明。

### 🎯 使用流程

1. **发送帮助命令**
   ```
   /help
   ```
   或使用别名：
   ```
   /h  或  /?  或  /man
   ```

2. **查看响应**
   - 显示所有已注册应用的列表
   - 包含应用名称、描述、触发命令和别名

### 💡 使用示例

```
用户: /help

机器人: 飞书机器人命令帮助

📌 /bash - 命令执行
   执行安全的bash命令
   别名: /cmd, /shell, /exec

📌 /time - 时间查询
   查询当前系统时间
   别名: /t, /now, /date

📌 /help - 帮助信息
   显示所有可用命令和使用说明
   别名: /h, /?, /man

📌 /history - 历史查询
   查询对话历史消息，显示最近10条消息

📌 /opencode - OpenCode 助手
   通过飞书对话控制 OpenCode，支持多轮对话
   别名: /oc, /code

💡 提示：
   - 发送任意非命令消息也会显示此帮助信息
   - 命令和别名不区分大小写（如 /Bash、/BASH、/bash 都可以）
```

### ⚙️ 特性
- **大小写不敏感**: `/HELP`, `/Help`, `/help` 都可以
- **自动响应**: 发送非命令消息时自动显示帮助
- **实时更新**: 自动注册新应用到帮助列表

---

## 2️⃣ TimeApp - 时间查询

### 📝 功能说明
返回当前系统时间，格式为中文本地化时间。

### 🎯 使用流程

1. **发送时间命令**
   ```
   /time
   ```
   或使用别名：
   ```
   /t  或  /now  或  /date
   ```

2. **查看响应**
   - 显示格式化的当前时间
   - 格式：`2026年2月7日 星期五 05:31:47`

### 💡 使用示例

```
用户: /time

机器人: 当前时间：2026年2月7日 星期五 05:31:47
```

### ⚙️ 特性
- **中文本地化**: 使用中国locale格式化时间
- **包含星期**: 显示完整的星期信息
- **精确到秒**: 时间精确到秒级别

---

## 3️⃣ BashApp - 命令执行

### 📝 功能说明
在安全环境中执行白名单内的bash命令，支持同步和异步执行。

### 🎯 使用流程

#### 3.1 执行命令

1. **发送bash命令**
   ```
   /bash <命令>
   ```
   或使用别名：
   ```
   /cmd <命令>  或  /shell <命令>  或  /exec <命令>
   ```

2. **系统验证**
   - 检查命令是否在白名单中
   - 验证是否包含非法操作符（如 `|`, `&`, `;`, `>`, `<`）

3. **执行并返回结果**
   - 快速命令（<2秒）：直接返回结果
   - 中等命令（2-5秒）：先提示"执行中"，再返回结果
   - 慢速命令（>5秒）：异步执行，结果稍后发送

#### 3.2 查看命令历史

```
/bash history
```

显示最近10条命令执行历史，包括：
- 命令内容
- 执行状态（✓成功 / ✗失败）
- 输出结果（最多显示3行）

### 💡 使用示例

#### 示例1：列出文件
```
用户: /bash ls -la

机器人: total 88
drwxr-xr-x  20 root root 4096 Feb  7 05:30 .
drwxr-xr-x   1 root root 4096 Feb  7 04:22 ..
...
```

#### 示例2：查看文件内容
```
用户: /bash cat README.md

机器人: # 飞书机器人后端项目
基于 COLA 架构的飞书机器人后端...
```

#### 示例3：查看历史
```
用户: /bash history

机器人: === 命令历史 ===

1. [✓] ls -la
total 88
drwxr-xr-x  20 root root 4096...

2. [✗] cat nonexistent.txt
错误: No such file or directory...
```

### ⚙️ 安全白名单

**允许的基础命令**：
- 文件操作：`ls`, `ll`, `dir`, `cat`, `less`, `head`, `tail`
- 搜索工具：`find`, `grep`
- 网络工具：`ping`
- 信息查询：`pwd`, `whoami`, `date`, `uname`

**禁止的操作**：
- ❌ 管道：`|`
- ❌ 重定向：`>`, `<`, `>>`
- ❌ 后台运行：`&`
- ❌ 命令分隔：`;`
- ❌ 危险命令：`rm`, `mv`, `cp`, `chmod`, `chown`

### ⏱️ 执行策略

| 执行时长 | 处理方式 | 用户体验 |
|---------|---------|---------|
| < 2秒 | 同步执行 | 立即返回结果 |
| 2-5秒 | 同步执行 | 先提示"执行中"，再返回结果 |
| > 5秒 | 异步执行 | 提示"命令正在执行中"，结果稍后返回 |

### 📂 工作目录
- 命令在 `.workspace` 目录中执行
- 自动创建工作目录（如不存在）
- 隔离执行环境，保证安全性

---

## 4️⃣ HistoryApp - 历史查询

### 📝 功能说明
查询当前话题的最近10条历史消息。

### 🎯 使用流程

1. **发送历史命令**
   ```
   /history
   ```

2. **查看响应**
   - 显示最近10条消息
   - 包含发送时间和内容
   - 如有更多消息会提示

### 💡 使用示例

```
用户: /history

机器人: === 历史消息 ===

[2026-02-07 05:30:15] /help
[2026-02-07 05:30:20] /time
[2026-02-07 05:30:25] /bash ls -la
[2026-02-07 05:30:30] /bash history
...

(还有更多消息...)
```

### ⚙️ 特性
- **话题级别**: 只显示当前话题的历史
- **时间顺序**: 按时间正序排列
- **格式化时间**: `yyyy-MM-dd HH:mm:ss` 格式
- **限制数量**: 最多显示10条消息

---

## 5️⃣ OpenCodeApp - OpenCode 助手

### 📝 功能说明
通过飞书对话控制 OpenCode（AI代码助手），支持多轮对话和会话管理。

### 🎯 使用流程

#### 5.1 快速开始（4步初始化）

**步骤1：查看可用项目**
```
/opencode projects
```
或使用别名：
```
/opencode p
```

**步骤2：查看项目的最近会话**
```
/opencode sessions <项目名称>
```
示例：
```
/opencode sessions feishu-backend
```
或使用别名：
```
/opencode s feishu-backend
```

**步骤3：绑定会话到话题**
```
/opencode session continue <会话ID>
```
或使用简写：
```
/opencode sc <会话ID>
```

**步骤4：开始对话**
```
/opencode chat <你的问题>
```

在已初始化的话题中，也可以直接输入问题（无需命令前缀）：
```
帮我写个排序函数
```

#### 5.2 对话命令

**发送对话（推荐）**
```
/opencode chat <内容>
```

**创建新会话**
```
/opencode new <提示词>
```

#### 5.3 项目管理

**查看项目列表**
```
/opencode projects
```

**查看项目会话**
```
/opencode sessions <项目名称>
```

#### 5.4 会话管理

**查看当前会话信息**
```
/opencode session status
```

**查看所有会话**
```
/opencode session list
```

**继续指定会话**
```
/opencode session continue <会话ID>
```

**重置话题**
```
/opencode reset
```

### 💡 完整使用示例

#### 场景1：新项目首次使用

```
用户: /opencode projects

机器人: 🔗 **OpenCode 连接成功**

**服务状态**
✓ 服务运行正常

**📁 可用项目**
- feishu-backend
- other-project

**💡 下一步操作**
1️⃣ 查看项目的最近会话：
   `/opencode sessions <项目名称>`
   示例：`/opencode sessions feishu-backend`

2️⃣ 选择会话并绑定：
   `/opencode session continue <会话ID>`

3️⃣ 开始对话：
   `/opencode chat <你的问题>`
   或直接输入（在已初始化的话题中）

---

用户: /opencode sessions feishu-backend

机器人: 📋 **feishu-backend 项目的最近会话**

最近会话（按时间倒序）：
1. ses_abc123 - 2小时前
   "重构登录模块"
   
2. ses_def456 - 1天前
   "添加单元测试"

---

用户: /opencode sc ses_abc123

机器人: ✅ 会话已绑定

当前话题已连接到会话：ses_abc123

💡 现在可以直接开始对话了！

---

用户: /opencode chat 帮我写个排序函数

机器人: [AI回复排序函数代码...]
```

#### 场景2：在已初始化话题中继续对话

```
话题已绑定会话 ses_abc123

用户: 添加单元测试

机器人: [AI回复单元测试代码...]

用户: 优化性能

机器人: [AI回复性能优化建议...]
```

### ⚙️ 命令别名速查表

| 全称命令 | 简写 | 说明 |
|---------|------|------|
| `/opencode projects` | `/opencode p` | 查看项目列表 |
| `/opencode sessions` | `/opencode s` | 查看项目会话 |
| `/opencode session continue` | `/opencode sc` | 绑定会话 |
| `/opencode` | `/oc`, `/code` | 应用前缀 |

### 🎨 话题状态说明

OpenCode 支持三种话题状态：

| 状态 | 条件 | 允许的命令 |
|------|------|-----------|
| **NON_TOPIC** | 非话题环境 | `connect`, `help`, `projects`, `p`, `reset` |
| **UNINITIALIZED** | 话题未绑定会话 | `projects`, `p`, `sessions`, `s`, `session`, `sc`, `reset` |
| **INITIALIZED** | 话题已绑定会话 | 所有命令 |

### 💡 使用技巧

1. **直接对话**：在已初始化的话题中，无需 `/opencode chat` 前缀
2. **会话保持**：话题会保持与 OpenCode 会话的绑定
3. **重置话题**：使用 `/opencode reset` 可以解除绑定，重新初始化
4. **查看状态**：随时使用 `/opencode session status` 查看当前会话

---

## 📚 附录

### A. 命令格式规范

**标准格式**：
```
/<应用ID> [参数]
```

**示例**：
```
/time
/bash ls -la
/opencode chat 帮我写代码
```

### B. 大小写规则

所有命令和别名**不区分大小写**：
```
/HELP = /help = /Help
/BASH = /bash = /Bash
/TIME = /time = /Time
```

### C. 命令白名单验证

部分应用（如 `bash`）使用命令白名单机制：
- 只允许执行安全的命令
- 自动过滤危险操作符
- 保护系统安全

### D. 回复模式

| 应用 | 回复模式 | 说明 |
|------|---------|------|
| help | DIRECT | 直接回复，无话题 |
| time | TOPIC | 回复到话题 |
| bash | TOPIC | 回复到话题 |
| history | TOPIC | 回复到话题 |
| opencode | TOPIC | 回复到话题 |

---

## 🆘 常见问题

**Q1: 如何查看所有可用命令？**
```
A: 发送 /help 查看完整的命令列表
```

**Q2: 命令一定要区分大小写吗？**
```
A: 不需要，所有命令都支持大小写不敏感
```

**Q3: 为什么有些命令执行很慢？**
```
A: Bash命令执行时间超过5秒会异步执行，结果会稍后返回
```

**Q4: OpenCode 需要初始化吗？**
```
A: 是的，需要先查看项目、选择会话、绑定话题，然后才能开始对话
```

**Q5: 如何重置 OpenCode 话题？**
```
A: 使用 /opencode reset 命令可以重置话题，重新初始化
```

---

**最后更新**: 2026-02-07
**相关文档**: [AGENTS.md](./AGENTS.md) | [APP_GUIDE.md](./APP_GUIDE.md)
